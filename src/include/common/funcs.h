#pragma once
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include "common/struct.h"

////////////////////////////////////////////////////////////////////////////////
// public
////////////////////////////////////////////////////////////////////////////////
void invalid_call(const char *state);
void invalid_token(const token *t);
void invalid_instuction(const int line);

////////////////////////////////////////////////////////////////////////////////
// io
////////////////////////////////////////////////////////////////////////////////
int file_read_content(const char *file_path, char **str);
int file_write_content(code_list *codes, const char *asm_file);

////////////////////////////////////////////////////////////////////////////////
// token
////////////////////////////////////////////////////////////////////////////////
token *create_token(const char *str, int type);
void token_print(token *t);

////////////////////////////////////////////////////////////////////////////////
// token_list
////////////////////////////////////////////////////////////////////////////////
int token_list_init(token_list *tl);
int token_list_push(token_list *tl, token *t);
void token_list_print(const token_list *tl);
void token_push_char(token *t, char ch);

////////////////////////////////////////////////////////////////////////////////
// syntax_tree_list
////////////////////////////////////////////////////////////////////////////////
syntax_tree *create_ast_node(token *t);
void syntax_tree_print(const syntax_tree *ast);

////////////////////////////////////////////////////////////////////////////////
// symbol_table
////////////////////////////////////////////////////////////////////////////////
symbol_table *create_symbol_table();
symbol_space *create_symbol_space(const char *space_name);
symbol_space *get_global_space(const symbol_table *table);
symbol_space *get_symbol_space(symbol_table **table, const char *space_name);
symbol_space *find_symbol_space(const symbol_table *table, const char *space_name);
symbol *create_symbol(const char *var_name, int var_idx, int var_size);
symbol *find_symbol(const symbol_table *table, const char *space_name, const char *var_name);
void init_space_symbol(symbol_space *space, const int size);
void symbol_table_print(const symbol_table *table);

////////////////////////////////////////////////////////////////////////////////
// code_list
////////////////////////////////////////////////////////////////////////////////
code_list *create_code_list();
int code_list_push(code_list *cl, instruction ins, char *str);
void code_list_push2(code_list *cl, code *c);
void code_list_append(code_list *codes, code_list *extras);
void code_list_print(code_list *cl);
void code_list_set(code_list *cl, const int idx, char *offset);
void code_list_clean(code_list *cl);

////////////////////////////////////////////////////////////////////////////////
// code_segment
////////////////////////////////////////////////////////////////////////////////
code_segment *create_code_segment();
void code_segment_push(code_segment *cs, instruction ins, int offset);

////////////////////////////////////////////////////////////////////////////////
// map_list
////////////////////////////////////////////////////////////////////////////////
map_list *create_map_list(const char *name);
map_list *find_map_list(code_map *c_map, const char *space);

////////////////////////////////////////////////////////////////////////////////
// code_map
////////////////////////////////////////////////////////////////////////////////
void set_code_map(code_map *c_map, const char *cur_space, const code_list *cl);
void code_map_print(const code_map *c_map);
code_map *create_code_map();

////////////////////////////////////////////////////////////////////////////////
// func_jump_map
////////////////////////////////////////////////////////////////////////////////
func_jump_map *create_jump_map();
int get_func_jump_num(func_jump_map *jumps, char *name);
func_jump *create_func_jump(char *func_name, int jump_num);
void set_func_jump_map(func_jump_map *jumps, char *func_name, int jump_num);
void func_jump_map_print(const func_jump_map *jumps);

////////////////////////////////////////////////////////////////////////////////
// virtual machine
////////////////////////////////////////////////////////////////////////////////
virtual_machine *create_virtual_machine();
vm_stack *create_vm_stack();
int vm_stack_pop(vm_stack *vm);
int vm_stack_back(const vm_stack *vm);
int vm_stack_size(const vm_stack *vm);
int vm_stack_get(const vm_stack *vm, const int index);
void vm_stack_push(vm_stack *vm, const int value);
void vm_stack_set(vm_stack *vm, const int index, const int value);